<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>แบบฟอร์มประเมินความพึงพอใจ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">
  <div class="container my-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="card-title mb-4">แบบฟอร์มประเมินความพึงพอใจ</h2>
        <form id="surveyForm">
          <div id="questionsContainer"></div>

          <div class="mb-4">
            <label for="comment" class="form-label fw-bold">ความคิดเห็นเพิ่มเติม</label>
            <textarea class="form-control" id="comment" name="comment" rows="4" placeholder="กรอกความคิดเห็นของคุณ..."></textarea>
          </div>

          <button type="submit" class="btn btn-primary w-100 mt-4">ส่งแบบประเมิน</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const questions = [
      { id: 1, text: "การจัดกิจกรรมหรือกระบวนการเตรียมความพร้อม ให้นักศึกษาก่อนเข้าศึกษา", topic: "การจัดการเรียนการสอน", order: 1 },
      { id: 2, text: "ระบบการประเมินผลของรายวิชาที่เปิดสอน มีวิธีประเมินที่หลากหลาย", topic: "การจัดการเรียนการสอน", order: 2 },
      { id: 3, text: "ระบบการประเมินรายวิชา ผ่านระบบออนไลน์", topic: "การจัดการเรียนการสอน", order: 3 },
      { id: 4, text: "ระบบการประเมินอาจารย์ผู้สอน ผ่านระบบออนไลน์", topic: "การจัดการเรียนการสอน", order: 4 },
      { id: 5, text: "ระบบการสอบประมวลความรอบรู้", topic: "การจัดการเรียนการสอน", order: 5 },
      { id: 6, text: "รูปแบบ/ระบบการจัดการฝึกปฏิบัติงานเชิงวิชาชีพตลอดทั้งปี 4", topic: "การฝึกปฏิบัติ/วิชาชีพ", order: 1 },
      { id: 7, text: "ช่องทาง/ความสะดวกในการติดต่อกับอาจารย์ที่ปรึกษา", topic: "การให้คำปรึกษา", order: 1 },
      { id: 8, text: "นักศึกษาได้รับคำแนะนำการลงทะเบียนเรียน การกำหนดแผนการเรียน", topic: "การให้คำปรึกษา", order: 2 },
      { id: 9, text: "อาจารย์ที่ปรึกษาด้านวิชาการให้ความช่วยเหลือ", topic: "การให้คำปรึกษา", order: 3 },
      { id: 10, text: "ความพร้อม ความเพียงพอของหนังสือ ตำราในห้องสมุด", topic: "ทรัพยากรและสิ่งอำนวยความสะดวก", order: 1 },
      { id: 11, text: "ความสะดวกสบายของสถานที่เรียน", topic: "ทรัพยากรและสิ่งอำนวยความสะดวก", order: 2 }
    ];

    const grouped = questions.reduce((acc, q) => {
      if (!acc[q.topic]) acc[q.topic] = [];
      acc[q.topic].push(q);
      return acc;
    }, {});

    const container = document.getElementById("questionsContainer");
    Object.entries(grouped).forEach(([topic, qs]) => {
      qs.sort((a, b) => a.order - b.order);
      const topicDiv = document.createElement("div");
      topicDiv.className = "mb-4";
      topicDiv.innerHTML = `<h5 class="text-primary mb-3">${topic}</h5>`;
      
      qs.forEach(q => {
        const qDiv = document.createElement("div");
        qDiv.className = "mb-3 p-3 border rounded bg-white";
        qDiv.innerHTML = `
          <label class="form-label fw-bold">${q.id}. ${q.text}</label>
          <div class="d-flex flex-wrap gap-3">
        ${[1,2,3,4,5].map(val => {
          let label;
          switch (val) {
            case 1: label = "(1) ไม่พึงพอใจมากที่สุด"; break;
            case 2: label = "(2) ไม่พึงพอใจ"; break;
            case 3: label = "(3) ปานกลาง"; break;
            case 4: label = "(4) พึงพอใจ"; break;
            case 5: label = "(5) พึงพอใจมากที่สุด"; break;
          }
          return `
            <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" 
             name="q${q.id}" id="q${q.id}_${val}" value="${val}" required>
          <label class="form-check-label" for="q${q.id}_${val}">${label}</label>
            </div>
          `;
        }).join("")}
          </div>
        `;
        topicDiv.appendChild(qDiv);
      });

      container.appendChild(topicDiv);
    });

    document.getElementById("surveyForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const answers = {};
      for (const [key, value] of formData.entries()) {
        answers[key] = value;
      }

      fetch("save_survey.php", {
        method: "POST",
        body: JSON.stringify(answers),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          Swal.fire({
            icon: "success",
            title: "ส่งแบบประเมินเรียบร้อย ✅",
            text: "ขอบคุณสำหรับความร่วมมือของคุณ",
            timer: 3000,
            showConfirmButton: false
          }).then(() => {
            location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "เกิดข้อผิดพลาด ❌",
            text: data.message || "ไม่สามารถบันทึกข้อมูลได้"
          });
        }
      })
      .catch(err => {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "เชื่อมต่อเซิร์ฟเวอร์ไม่ได้ ❌",
          text: "กรุณาลองใหม่อีกครั้ง"
        });
      });
    });
  </script>
</body>
</html>